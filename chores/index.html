<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tarefas da Semana</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            :root {
                --default-stripe-color: #e2e8f0; /* Cor da listra zebrada (slate-200) */
                --default-white-color: #ffffff;
            }
            body {
                font-family: "Inter", sans-serif;
                background-color: #f0f2f5;
            }

            /* Single Day Task Section */
            #single-day-tasks-section h3 {
                font-size: 1.125rem;
                font-weight: 600;
                color: #475569; /* slate-600 */
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #e2e8f0; /* slate-200 */
            }
            .single-day-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 1rem;
            }
            .day-column {
                background-color: #f8fafc; /* slate-50 */
                border-radius: 8px;
                padding: 0.75rem;
                border: 1px solid #e2e8f0; /* slate-200 */
            }
            .day-column-header {
                font-weight: 600;
                color: #475569; /* slate-600 */
                margin-bottom: 0.75rem;
                text-align: center;
            }
            .single-day-task-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                border-radius: 6px;
                background-color: #fff;
                border-left: 5px solid transparent;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                cursor: pointer;
                transition:
                    box-shadow 0.2s,
                    transform 0.2s;
            }
            .single-day-task-item:hover {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transform: translateY(-2px);
            }
            .single-day-task-name {
                flex-grow: 1;
                text-transform: uppercase;
                font-size: 0.8rem;
                font-weight: 500;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-right: 0.5rem;
            }
            .single-task-delete-btn {
                flex-shrink: 0;
                opacity: 0.5;
                transition: opacity 0.2s;
            }
            .single-day-task-item:hover .single-task-delete-btn {
                opacity: 1;
            }

            /* Main Task Table */
            .task-table-container {
                overflow-x: auto;
            }

            .task-table {
                width: 100%;
                border-collapse: collapse;
            }

            .task-table th,
            .task-table td {
                border: 1px solid #e2e8f0; /* slate-200 */
                padding: 0.75rem 0.4rem;
                text-align: left;
                vertical-align: middle;
            }

            .task-table th {
                background-color: #f8fafc; /* slate-50 */
                font-weight: 600;
                font-size: 0.875rem;
                color: #475569; /* slate-600 */
            }
            .task-table th.task-name-header {
                width: 35%;
            }
            .task-table th.task-color-header {
                width: 70px;
                text-align: center;
            }
            .task-table th.day-header {
                text-align: center;
                min-width: 90px;
            }
            .task-table td.task-name-cell {
                padding-left: 0.6rem;
                padding-right: 0.6rem;
                transition: background-color 0.3s ease;
            }
            .task-table td.actions-cell {
                display: flex;
                align-items: center;
                gap: 2px;
            }

            .task-row {
                transition: background-color 0.3s ease;
            }

            .task-row.dragging {
                opacity: 0.6;
                background-color: #c7d2fe !important;
            }
            .task-row.dragging .task-name-cell {
                background-color: transparent !important;
            }

            .drag-handle {
                cursor: grab;
                padding-right: 0.5rem;
                color: #94a3b8; /* slate-400 */
            }
            .drag-handle:active {
                cursor: grabbing;
            }

            .task-name-text {
                text-transform: uppercase;
                cursor: pointer;
            }
            .task-name-text:hover {
                background-color: #f0f9ff; /* sky-50 */
            }

            .task-name-edit-input {
                font-family: "Inter", sans-serif;
                text-transform: uppercase;
                font-weight: 500;
                width: 100%;
                background-color: #f0f9ff;
                border: 1px solid #38bdf8;
                border-radius: 4px;
                padding: 2px 4px;
            }

            .custom-checkbox {
                width: 32px;
                height: 32px;
                border: 2px solid #cbd5e1;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition:
                    background-color 0.2s,
                    border-color 0.2s;
                margin: auto;
            }
            .custom-checkbox.checked {
                background-color: transparent;
                border-color: transparent;
            }
            .custom-checkbox.checked::after {
                content: "";
                display: block;
                width: 20px;
                height: 20px;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23dc2626' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cline x1='18' y1='6' x2='6' y2='18'/%3e%3cline x1='6' y1='6' x2='18' y2='18'/%3e%3c/svg%3e");
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }

            .item-color-picker {
                width: 32px;
                height: 32px;
                padding: 1px;
                border: 1px solid #d1d5db;
                border-radius: 5px;
                cursor: pointer;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-color: transparent;
            }
            .item-color-picker::-webkit-color-swatch-wrapper {
                padding: 0;
            }
            .item-color-picker::-webkit-color-swatch {
                border: none;
                border-radius: 3px;
            }
            .item-color-picker::-moz-color-swatch {
                border: none;
                border-radius: 3px;
            }

            .action-button {
                transition:
                    background-color 0.3s ease,
                    transform 0.2s ease;
            }
            .action-button:hover {
                transform: translateY(-2px);
            }
            .action-button:active {
                transform: translateY(0px);
            }

            /* REGRAS DE IMPRESSÃO OTIMIZADAS */
            @media print {
                body {
                    background-color: #fff !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }

                .no-print,
                header,
                .add-task-section,
                footer,
                #single-day-tasks-section {
                    display: none !important;
                }

                .container,
                .task-list-section,
                .task-table-container {
                    width: 100% !important;
                    max-width: 100% !important;
                    box-shadow: none !important;
                    border: none !important;
                    padding: 0 !important;
                    margin: 0 !important;
                }

                .task-table {
                    border-style: hidden;
                    border-collapse: collapse;
                }

                .task-table th,
                .task-table td {
                    border: 1px solid #666 !important;
                    padding: 4px 2px;
                    word-break: break-word;
                }

                .task-table th {
                    background-color: #e9e9e9 !important;
                }

                .task-table th.task-name-header,
                .task-table td.task-name-cell {
                    width: 50% !important;
                    padding-left: 5px !important;
                }

                .task-table th.day-header,
                .task-table td.day-checkbox-cell {
                    min-width: auto !important;
                    width: auto !important;
                    padding: 4px 1px !important;
                    text-align: center !important;
                }

                .custom-checkbox.checked {
                    background-color: transparent !important;
                    border-color: transparent !important;
                }
                .custom-checkbox.checked::after {
                    content: "" !important;
                    display: block !important;
                    width: 80% !important;
                    height: 80% !important;
                    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23dc2626' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cline x1='18' y1='6' x2='6' y2='18'/%3e%3cline x1='6' y1='6' x2='18' y2='18'/%3e%3c/svg%3e") !important;
                    background-size: contain !important;
                    background-repeat: no-repeat !important;
                    background-position: center !important;
                    background-color: transparent !important;
                    border-radius: 0 !important;
                }

                .task-name-text {
                    font-weight: normal;
                    text-transform: uppercase;
                }

                .task-row,
                .task-name-cell {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800 p-4 md:p-8">
        <div
            class="container max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl"
        >
            <div class="print-header hidden print:block text-center mb-4">
                <h1 class="text-2xl font-bold text-black">Tarefas da Semana</h1>
                <p class="text-sm text-slate-600">
                    Marque um traço diagonal nas tarefas feitas ou vencidas
                </p>
            </div>

            <header class="mb-8 text-center no-print">
                <h1
                    class="text-3xl md:text-4xl font-bold text-sky-600 main-title"
                >
                    Tarefas da Semana
                </h1>
                <p class="text-md text-slate-500 mt-2">
                    Marque um traço diagonal nas tarefas feitas ou vencidas
                </p>
            </header>

            <section
                class="add-task-section mb-8 p-6 bg-slate-50 rounded-lg shadow no-print"
            >
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow">
                        <label
                            for="task-name-input"
                            class="block text-sm font-medium text-slate-600 mb-1"
                            >Nova Tarefa:</label
                        >
                        <input
                            type="text"
                            id="task-name-input"
                            placeholder="Ex: Lavar a louça"
                            class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow"
                        />
                    </div>
                    <button
                        id="add-task-button"
                        class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md w-full sm:w-auto"
                    >
                        Adicionar
                    </button>
                </div>
            </section>

            <section
                id="single-day-tasks-section"
                class="mb-8 no-print"
            ></section>

            <section class="task-list-section">
                <h2 class="text-2xl font-semibold mb-4 text-slate-700 sr-only">
                    Tarefas Recorrentes
                </h2>
                <div
                    id="task-table-container"
                    class="task-table-container bg-white rounded-lg shadow"
                >
                    <table class="task-table">
                        <thead id="task-table-head">
                            <!-- Header generated by JS -->
                        </thead>
                        <tbody id="task-table-body">
                            <!-- Tasks generated by JS -->
                        </tbody>
                    </table>
                </div>
                <p
                    id="no-tasks-message"
                    class="text-center text-slate-500 mt-6"
                >
                    Nenhuma tarefa adicionada ainda. Clique em "Adicionar" ou
                    recarregue a página para ver exemplos.
                </p>
            </section>

            <footer class="mt-10 text-center no-print">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <label
                        for="print-font-size"
                        class="text-sm font-medium text-slate-600"
                        >Fonte (Impressão):</label
                    >
                    <input
                        type="number"
                        id="print-font-size"
                        value="9"
                        min="6"
                        max="16"
                        class="w-20 p-2 border border-slate-300 rounded-lg text-center"
                    />
                </div>
                <div class="flex justify-center items-center gap-2 flex-wrap">
                    <button
                        id="import-button"
                        class="action-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md"
                    >
                        Importar JSON
                    </button>
                    <button
                        id="export-button"
                        class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md"
                    >
                        Exportar JSON
                    </button>
                    <button
                        id="share-button"
                        class="action-button bg-purple-500 hover:bg-purple-600 text-white font-semibold p-3 rounded-lg shadow-md hidden"
                        title="Compartilhar"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-share-2"
                        >
                            <circle cx="18" cy="5" r="3" />
                            <circle cx="6" cy="12" r="3" />
                            <circle cx="18" cy="19" r="3" />
                            <line x1="8.59" x2="15.42" y1="13.51" y2="17.49" />
                            <line x1="15.41" x2="8.59" y1="6.51" y2="10.49" />
                        </svg>
                    </button>
                    <button
                        id="print-button"
                        class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md"
                    >
                        Imprimir Lista
                    </button>
                </div>
                <input
                    type="file"
                    id="import-file-input"
                    class="hidden"
                    accept="application/json"
                />
            </footer>
        </div>

        <script>
            // =================================================================================
            // DOM ELEMENT SELECTORS & GLOBAL CONSTANTS
            // =================================================================================

            const taskNameInput = document.getElementById("task-name-input");
            const addTaskButton = document.getElementById("add-task-button");
            const singleDayTasksSection = document.getElementById(
                "single-day-tasks-section",
            );
            const taskTableHead = document.getElementById("task-table-head");
            const taskTableBody = document.getElementById("task-table-body");
            const taskTableContainer = document.getElementById(
                "task-table-container",
            );
            const printButton = document.getElementById("print-button");
            const noTasksMessage = document.getElementById("no-tasks-message");
            const printFontSizeInput =
                document.getElementById("print-font-size");
            const importButton = document.getElementById("import-button");
            const exportButton = document.getElementById("export-button");
            const shareButton = document.getElementById("share-button");
            const importFileInput =
                document.getElementById("import-file-input");

            const WEEK_DAYS = [
                { name: "Domingo", short: "Dom", index: 0 },
                { name: "Segunda", short: "Seg", index: 1 },
                { name: "Terça", short: "Ter", index: 2 },
                { name: "Quarta", short: "Qua", index: 3 },
                { name: "Quinta", short: "Qui", index: 4 },
                { name: "Sexta", short: "Sex", index: 5 },
                { name: "Sábado", short: "Sáb", index: 6 },
            ];

            // =================================================================================
            // UTILITY FUNCTIONS
            // =================================================================================

            /**
             * Lightens a HEX color by a given percentage.
             * @param {string} hex - The hex color string (e.g., '#RRGGBB').
             * @param {number} percent - The percentage to lighten the color (0-100).
             * @returns {string} The new, lightened hex color string. Returns a default if input is invalid.
             */
            function lightenHexColor(hex, percent) {
                if (!hex || typeof hex !== "string")
                    return "var(--default-white-color)";
                hex = hex.replace(/^#/, "");
                if (hex.length === 3)
                    hex = hex
                        .split("")
                        .map((char) => char + char)
                        .join("");
                if (hex.length !== 6) return "var(--default-white-color)";

                let r = parseInt(hex.substring(0, 2), 16);
                let g = parseInt(hex.substring(2, 4), 16);
                let b = parseInt(hex.substring(4, 6), 16);

                r = Math.min(255, r + Math.floor((255 - r) * (percent / 100)));
                g = Math.min(255, g + Math.floor((255 - g) * (percent / 100)));
                b = Math.min(255, b + Math.floor((255 - b) * (percent / 100)));

                return `#${r.toString(16).padStart(2, "0")}${g.toString(16).padStart(2, "0")}${b.toString(16).padStart(2, "0")}`;
            }

            // =================================================================================
            // CORE APPLICATION LOGIC & RENDERING
            // =================================================================================

            /**
             * Main function to render the entire application UI.
             * It fetches tasks, separates them, and calls specific render functions for each section.
             */
            function renderApp() {
                const allTasks = getTasksFromStorage();

                const singleDayTasks = allTasks.filter(
                    (task) => task.checkedDays.filter(Boolean).length === 1,
                );
                const multiDayTasks = allTasks.filter(
                    (task) => task.checkedDays.filter(Boolean).length !== 1,
                );

                renderSingleDaySection(singleDayTasks);
                renderMultiDaySection(multiDayTasks);

                updateNoTasksMessage(allTasks.length);
                applyRowBackgrounds();
            }

            /**
             * Renders the compact section for tasks that occur on only one day of the week.
             * @param {Array<Object>} tasks - An array of single-day task objects.
             */
            function renderSingleDaySection(tasks) {
                if (tasks.length === 0) {
                    singleDayTasksSection.innerHTML = "";
                    singleDayTasksSection.classList.add("hidden");
                    return;
                }

                singleDayTasksSection.classList.remove("hidden");
                let gridHtml = `<h3>Tarefas de Dia Único <span class="text-sm font-normal text-slate-500">(Clique para editar na tabela)</span></h3>`;
                gridHtml += `<div class="single-day-grid">`;

                WEEK_DAYS.forEach((day) => {
                    const tasksForDay = tasks.filter(
                        (task) => task.checkedDays[day.index],
                    );
                    gridHtml += `<div class="day-column">`;
                    gridHtml += `<div class="day-column-header">${day.name}</div>`;
                    if (tasksForDay.length > 0) {
                        tasksForDay.forEach((task) => {
                            const colorStyle =
                                task.backgroundColor &&
                                task.backgroundColor !== "#ffffff"
                                    ? `border-left-color: ${task.backgroundColor};`
                                    : "";

                            gridHtml += `
            <div class="single-day-task-item"
                 style="${colorStyle}"
                 title="Clique para mover para a tabela e editar"
                 data-task-id="${task.id}"
                 onclick="editSingleDayTask(event)">
              <span class="single-day-task-name">${task.name}</span>
              <button class="single-task-delete-btn" title="Excluir tarefa" onclick="deleteTask(event, '${task.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
          `;
                        });
                    }
                    gridHtml += `</div>`; // close day-column
                });
                gridHtml += `</div>`; // close single-day-grid
                singleDayTasksSection.innerHTML = gridHtml;
            }

            /**
             * Renders the main table for tasks that are multi-day or have no days selected.
             * @param {Array<Object>} tasks - An array of multi-day task objects.
             */
            function renderMultiDaySection(tasks) {
                taskTableHead.innerHTML = "";
                taskTableBody.innerHTML = "";

                // Render header
                const headerHTML = `
      <tr>
        <th class="no-print" style="width: 30px; padding-left: 0.3rem; padding-right: 0.3rem;"></th>
        <th class="task-name-header">Tarefa Recorrente / Sem Dia Definido</th>
        <th class="task-color-header no-print">Cor</th>
        ${WEEK_DAYS.map((day) => `<th class="day-header">${day.short}</th>`).join("")}
        <th class="no-print" style="width: 90px; padding-left: 0.3rem; padding-right: 0.3rem;"></th>
      </tr>
    `;
                taskTableHead.innerHTML = headerHTML;

                // Render task rows
                tasks.forEach((task) => {
                    const taskRowElement = createTaskRow(task);
                    if (taskRowElement) {
                        taskTableBody.appendChild(taskRowElement);
                    }
                });

                taskTableContainer.classList.toggle(
                    "hidden",
                    tasks.length === 0,
                );
            }

            /**
             * Creates a single task row element (TR) for the main table.
             * @param {Object} task - The task object from storage.
             * @returns {HTMLElement|null} The fully constructed TR element or null if invalid.
             */
            function createTaskRow(task) {
                if (!task.name || !task.name.trim()) return null;

                const taskRow = document.createElement("tr");
                taskRow.className = "task-row";
                taskRow.draggable = true;
                taskRow.id = task.id;

                // --- Drag Handle Cell ---
                const dragHandleCell = document.createElement("td");
                dragHandleCell.className = "drag-handle-cell no-print";
                dragHandleCell.innerHTML = `<span class="drag-handle" title="Arraste para reordenar">☰</span>`;
                taskRow.appendChild(dragHandleCell);

                // --- Task Name Cell (with in-place editing) ---
                const nameCell = document.createElement("td");
                nameCell.className = "task-name-cell";
                const taskNameText = document.createElement("span");
                taskNameText.className =
                    "task-name-text text-slate-700 font-medium break-words";
                taskNameText.textContent = task.name;
                const taskNameInputEl = document.createElement("input");
                taskNameInputEl.type = "text";
                taskNameInputEl.className = "task-name-edit-input hidden";
                taskNameInputEl.value = task.name;
                nameCell.append(taskNameText, taskNameInputEl);

                taskNameText.addEventListener("click", () => {
                    taskNameText.classList.add("hidden");
                    taskNameInputEl.classList.remove("hidden");
                    taskNameInputEl.focus();
                    taskNameInputEl.select();
                });
                const saveNameEdit = () => {
                    const newName = taskNameInputEl.value.trim();
                    if (newName) {
                        updateTaskProperty(task.id, "name", newName);
                        taskNameText.textContent = newName;
                    }
                    taskNameInputEl.classList.add("hidden");
                    taskNameText.classList.remove("hidden");
                };
                taskNameInputEl.addEventListener("blur", saveNameEdit);
                taskNameInputEl.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        taskNameInputEl.blur();
                    }
                    if (e.key === "Escape") {
                        taskNameInputEl.value = task.name;
                        taskNameInputEl.blur();
                    }
                });
                taskRow.appendChild(nameCell);

                // --- Color Picker Cell ---
                const itemColorCell = document.createElement("td");
                itemColorCell.className =
                    "item-color-cell no-print text-center";
                const itemColorInput = document.createElement("input");
                itemColorInput.type = "color";
                itemColorInput.className = "item-color-picker";
                itemColorInput.value = task.backgroundColor || "#ffffff";
                itemColorInput.title = "Escolher ou remover cor";
                itemColorInput.addEventListener("click", (e) => {
                    if (itemColorInput.value.toLowerCase() !== "#ffffff") {
                        e.preventDefault();
                        itemColorInput.value = "#ffffff";
                        itemColorInput.dispatchEvent(
                            new Event("input", { bubbles: true }),
                        );
                    }
                });
                itemColorInput.addEventListener("input", (e) => {
                    updateTaskProperty(
                        task.id,
                        "backgroundColor",
                        e.target.value,
                    );
                    renderApp(); // Re-render to update single-day view as well
                });
                itemColorCell.appendChild(itemColorInput);
                taskRow.appendChild(itemColorCell);

                // --- Daily Checkbox Cells ---
                WEEK_DAYS.forEach((day) => {
                    const dayCell = document.createElement("td");
                    dayCell.className = "day-checkbox-cell text-center";
                    const checkbox = document.createElement("div");
                    checkbox.className = "checkbox-placeholder custom-checkbox";
                    if (task.checkedDays && task.checkedDays[day.index]) {
                        checkbox.classList.add("checked");
                        checkbox.setAttribute("aria-checked", "true");
                    } else {
                        checkbox.setAttribute("aria-checked", "false");
                    }
                    checkbox.tabIndex = 0;
                    checkbox.onclick = function () {
                        const isChecked = this.classList.toggle("checked");
                        this.setAttribute("aria-checked", isChecked);

                        // This is the core logic update
                        updateTaskProperty(
                            task.id,
                            "checkedDays",
                            (currentTask) => {
                                currentTask.checkedDays[day.index] = isChecked;

                                const checkedCount =
                                    currentTask.checkedDays.filter(
                                        Boolean,
                                    ).length;

                                // The "6-day rule"
                                if (checkedCount === 6) {
                                    const singleDayIndex =
                                        currentTask.checkedDays.findIndex(
                                            (d) => !d,
                                        );
                                    const newCheckedDays = Array(7).fill(false);
                                    if (singleDayIndex !== -1) {
                                        newCheckedDays[singleDayIndex] = true;
                                    }
                                    currentTask.checkedDays = newCheckedDays;
                                }
                            },
                        );

                        renderApp(); // Re-render to move task between sections if needed
                    };
                    checkbox.onkeydown = (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            e.target.click();
                        }
                    };
                    dayCell.appendChild(checkbox);
                    taskRow.appendChild(dayCell);
                });

                // --- Actions Cell (Duplicate, Delete) ---
                const actionsCell = document.createElement("td");
                actionsCell.className = "actions-cell no-print";
                const duplicateButton = document.createElement("button");
                duplicateButton.className =
                    "duplicate-task-button text-blue-500 hover:text-blue-700 p-1";
                duplicateButton.title = "Duplicar tarefa";
                duplicateButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
                duplicateButton.onclick = () => {
                    const allTasks = getTasksFromStorage();
                    const taskIndex = allTasks.findIndex(
                        (t) => t.id === task.id,
                    );
                    if (taskIndex > -1) {
                        const newTask = {
                            ...allTasks[taskIndex],
                            id: `task-${Date.now()}`,
                        };
                        allTasks.splice(taskIndex + 1, 0, newTask);
                        localStorage.setItem("tasks", JSON.stringify(allTasks));
                        renderApp();
                    }
                };
                const deleteButton = document.createElement("button");
                deleteButton.className =
                    "delete-task-button text-red-500 hover:text-red-700 p-1";
                deleteButton.title = `Excluir tarefa ${task.name}`;
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
                deleteButton.onclick = (event) => deleteTask(event, task.id);

                actionsCell.append(duplicateButton, deleteButton);
                taskRow.appendChild(actionsCell);

                return taskRow;
            }

            /**
             * Toggles the visibility of the "no tasks" message.
             * @param {number} totalTasksCount - The total number of tasks.
             */
            function updateNoTasksMessage(totalTasksCount) {
                noTasksMessage.classList.toggle("hidden", totalTasksCount > 0);
            }

            /**
             * Applies background colors to rows (zebra-striping) and specific task name cells.
             */
            function applyRowBackgrounds() {
                const taskRows = taskTableBody.querySelectorAll(".task-row");
                const tasksData = getTasksFromStorage();

                taskRows.forEach((row, index) => {
                    const taskData = tasksData.find((t) => t.id === row.id);
                    // Step 1: Apply zebra striping to the entire row.
                    row.style.backgroundColor =
                        index % 2 !== 0
                            ? "var(--default-stripe-color)"
                            : "var(--default-white-color)";
                    // Step 2: If a custom color exists, apply it ONLY to the name cell, overriding the row color.
                    const nameCell = row.querySelector(".task-name-cell");
                    if (nameCell) {
                        nameCell.style.backgroundColor =
                            taskData &&
                            taskData.backgroundColor &&
                            taskData.backgroundColor.toLowerCase() !== "#ffffff"
                                ? lightenHexColor(taskData.backgroundColor, 60)
                                : ""; // Reset to inherit from row if no color.
                    }
                });
            }

            // =================================================================================
            // DATA PERSISTENCE (LOCALSTORAGE)
            // =================================================================================

            /**
             * Retrieves all tasks from localStorage.
             * @returns {Array<Object>} An array of task objects or an empty array.
             */
            function getTasksFromStorage() {
                try {
                    const tasks =
                        JSON.parse(localStorage.getItem("tasks")) || [];
                    // Data sanitization for older formats or missing properties
                    return tasks.map((task) => ({
                        id: task.id || `task-${Date.now()}`,
                        name: task.name || "Tarefa Sem Nome",
                        checkedDays:
                            Array.isArray(task.checkedDays) &&
                            task.checkedDays.length === 7
                                ? task.checkedDays
                                : Array(7).fill(false),
                        backgroundColor: task.backgroundColor || "#ffffff",
                    }));
                } catch {
                    return [];
                }
            }

            /**
             * Updates a specific property of a task in localStorage.
             * @param {string} taskId - The ID of the task to update.
             * @param {string} key - The property key to update (e.g., 'name', 'checkedDays').
             * @param {*} valueOrUpdater - The new value or a function that receives the task and modifies it.
             */
            function updateTaskProperty(taskId, key, valueOrUpdater) {
                const tasks = getTasksFromStorage();
                const taskIndex = tasks.findIndex((t) => t.id === taskId);
                if (taskIndex > -1) {
                    if (typeof valueOrUpdater === "function") {
                        valueOrUpdater(tasks[taskIndex]);
                    } else {
                        tasks[taskIndex][key] = valueOrUpdater;
                    }
                    localStorage.setItem("tasks", JSON.stringify(tasks));
                }
            }

            /**
             * Loads tasks from storage or populates with example tasks if storage is empty.
             */
            function loadInitialTasks() {
                let tasks = getTasksFromStorage();
                if (tasks.length === 0) {
                    tasks = [
                        {
                            id: `task-example-1`,
                            name: "Lavar a Louça",
                            checkedDays: [
                                true,
                                true,
                                true,
                                true,
                                true,
                                true,
                                true,
                            ],
                            backgroundColor: "#dbeafe",
                        },
                        {
                            id: `task-example-2`,
                            name: "Dobrar Roupas",
                            checkedDays: [
                                false,
                                false,
                                false,
                                false,
                                false,
                                false,
                                false,
                            ],
                            backgroundColor: "#e0e7ff",
                        },
                        {
                            id: `task-example-3`,
                            name: "Limpar Banheiro",
                            checkedDays: [
                                false,
                                false,
                                false,
                                false,
                                false,
                                false,
                                true,
                            ],
                            backgroundColor: "#ffedd5",
                        },
                    ];
                    localStorage.setItem("tasks", JSON.stringify(tasks));
                }
                renderApp();
            }

            // =================================================================================
            // EVENT LISTENERS
            // =================================================================================

            /**
             * Moves a single-day task to the main table for detailed editing by clearing its day selection.
             * @param {MouseEvent} event The click event.
             */
            function editSingleDayTask(event) {
                const taskId = event.currentTarget.dataset.taskId;
                // Just re-render. The task will appear in the main table if the user changes its days.
                // The key is that clicking it does not change its state, just prepares it for editing.
                // To move it back, we'll deselect its only day.
                updateTaskProperty(taskId, "checkedDays", Array(7).fill(false));
                renderApp();
            }

            /**
             * Deletes a task from any view.
             * @param {MouseEvent} event The click event.
             * @param {string} taskId The ID of the task to delete.
             */
            function deleteTask(event, taskId) {
                event.stopPropagation(); // Prevent parent clicks from firing
                const remainingTasks = getTasksFromStorage().filter(
                    (t) => t.id !== taskId,
                );
                localStorage.setItem("tasks", JSON.stringify(remainingTasks));
                renderApp();
            }

            // --- Drag and Drop for Task Reordering ---
            let draggedItem = null;
            taskTableBody.addEventListener("dragstart", (e) => {
                if (e.target.classList.contains("task-row")) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add("dragging"), 0);
                }
            });

            taskTableBody.addEventListener("dragend", () => {
                if (draggedItem) {
                    draggedItem.classList.remove("dragging");
                    const orderedIds = Array.from(
                        taskTableBody.querySelectorAll(".task-row"),
                    ).map((row) => row.id);
                    const allTasks = getTasksFromStorage();

                    const singleDayTasks = allTasks.filter(
                        (task) => task.checkedDays.filter(Boolean).length === 1,
                    );
                    const multiDayTasks = allTasks.filter(
                        (task) => task.checkedDays.filter(Boolean).length !== 1,
                    );

                    const reorderedMultiDayTasks = orderedIds
                        .map((id) => multiDayTasks.find((t) => t.id === id))
                        .filter(Boolean);

                    // Reassemble the list, preserving the single-day tasks' order relative to each other.
                    const singleDayTaskIds = singleDayTasks.map((t) => t.id);
                    const originalOrderSingleDayTasks =
                        getTasksFromStorage().filter((t) =>
                            singleDayTaskIds.includes(t.id),
                        );

                    const finalTaskList = [
                        ...originalOrderSingleDayTasks,
                        ...reorderedMultiDayTasks,
                    ];

                    localStorage.setItem(
                        "tasks",
                        JSON.stringify(finalTaskList),
                    );
                    draggedItem = null;
                    applyRowBackgrounds(); // Re-apply zebra striping after reordering.
                }
            });

            taskTableBody.addEventListener("dragover", (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(
                    taskTableBody,
                    e.clientY,
                );
                if (draggedItem) {
                    if (afterElement == null) {
                        taskTableBody.appendChild(draggedItem);
                    } else {
                        taskTableBody.insertBefore(draggedItem, afterElement);
                    }
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [
                    ...container.querySelectorAll(".task-row:not(.dragging)"),
                ];
                return draggableElements.reduce(
                    (closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - box.top - box.height / 2;
                        if (offset < 0 && offset > closest.offset) {
                            return { offset: offset, element: child };
                        }
                        return closest;
                    },
                    { offset: Number.NEGATIVE_INFINITY },
                ).element;
            }

            // --- Main Actions ---
            addTaskButton.addEventListener("click", () => {
                const taskNameValue = taskNameInput.value.trim();
                if (!taskNameValue) {
                    taskNameInput.classList.add("border-red-500");
                    taskNameInput.placeholder =
                        "Nome da tarefa não pode ser vazio!";
                    setTimeout(() => {
                        taskNameInput.classList.remove("border-red-500");
                        taskNameInput.placeholder = "Ex: Lavar a louça";
                    }, 2000);
                    taskNameInput.focus();
                    return;
                }
                const newTask = {
                    id: `task-${Date.now()}`,
                    name: taskNameValue,
                    checkedDays: Array(7).fill(false),
                    backgroundColor: "#ffffff",
                };
                const currentTasks = getTasksFromStorage();
                localStorage.setItem(
                    "tasks",
                    JSON.stringify([...currentTasks, newTask]),
                );
                renderApp();
                taskNameInput.value = "";
                taskNameInput.focus();
            });

            taskNameInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") addTaskButton.click();
            });

            // --- Import/Export/Share/Print ---
            exportButton.addEventListener("click", () => {
                const dataToExport = {
                    tasks: getTasksFromStorage(),
                    settings: { printFontSize: printFontSizeInput.value },
                };
                const dataBlob = new Blob(
                    [JSON.stringify(dataToExport, null, 2)],
                    { type: "application/json" },
                );
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "lista_de_tarefas.json";
                link.click();
                URL.revokeObjectURL(url);
            });

            importButton.addEventListener("click", () =>
                importFileInput.click(),
            );

            importFileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data && Array.isArray(data.tasks)) {
                            // Normalize data on import
                            const sanitizedTasks = data.tasks.map((task) => ({
                                id: task.id || `task-${Date.now()}`,
                                name: task.name || "Tarefa sem nome",
                                checkedDays:
                                    Array.isArray(task.checkedDays) &&
                                    task.checkedDays.length === 7
                                        ? task.checkedDays
                                        : Array(7).fill(false),
                                backgroundColor:
                                    task.backgroundColor || "#ffffff",
                            }));

                            localStorage.setItem(
                                "tasks",
                                JSON.stringify(sanitizedTasks),
                            );
                            if (data.settings?.printFontSize) {
                                printFontSizeInput.value =
                                    data.settings.printFontSize;
                                localStorage.setItem(
                                    "printFontSize",
                                    data.settings.printFontSize,
                                );
                            }
                            renderApp();
                            alert("Dados importados com sucesso!");
                        } else {
                            throw new Error(
                                "Formato do arquivo JSON é inválido.",
                            );
                        }
                    } catch (error) {
                        alert("Erro ao importar o arquivo: " + error.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = ""; // Reset for re-upload
            });

            shareButton.addEventListener("click", async () => {
                const data = {
                    tasks: getTasksFromStorage(),
                    settings: { printFontSize: printFontSizeInput.value },
                };
                const file = new File(
                    [JSON.stringify(data)],
                    "lista_de_tarefas.json",
                    { type: "application/json" },
                );
                if (
                    navigator.canShare &&
                    navigator.canShare({ files: [file] })
                ) {
                    await navigator
                        .share({ title: "Tarefas da Semana", files: [file] })
                        .catch(console.error);
                } else {
                    alert(
                        "Seu navegador não suporta o compartilhamento de arquivos.",
                    );
                }
            });

            printButton.addEventListener("click", () => {
                const fontSize = printFontSizeInput.value;
                localStorage.setItem("printFontSize", fontSize);
                const checkboxSize = parseFloat(fontSize) * 2.2;
                const printStyles = `
      @media print {
        :root {
          --print-font-size: ${fontSize}pt !important;
          --print-checkbox-size: ${checkboxSize}px !important;
        }
        .task-table, .task-table th, .task-table td, .task-name-text { font-size: var(--print-font-size); }
        .custom-checkbox { width: var(--print-checkbox-size); height: var(--print-checkbox-size); }
      }`;
                const styleSheet = document.createElement("style");
                styleSheet.id = "dynamic-print-style";
                styleSheet.innerText = printStyles;
                document.head.appendChild(styleSheet);
                window.print();
                styleSheet.remove(); // Clean up after print dialog
            });

            // =================================================================================
            // INITIALIZATION
            // =================================================================================

            /**
             * Sets up the initial state of the application on page load.
             */
            function initializeApp() {
                // Load saved settings
                printFontSizeInput.value =
                    localStorage.getItem("printFontSize") || "9";
                if (navigator.share) shareButton.classList.remove("hidden");

                // Load tasks and render the application
                loadInitialTasks();
            }

            initializeApp();
        </script>
    </body>
</html>
